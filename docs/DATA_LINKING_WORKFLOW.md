# Documentation: POI Data Linking Workflow

This document provides a detailed explanation of the data pipeline for processing, linking, and seeding the Point of Interest (POI) and map pattern data for the Nightreign Router application. This serves as the single source of truth for the implementation of the database seeding script.

## Core Problem and Goal

-   **Problem:** The original data pipeline created duplicate POIs for each map layout, resulting in inconsistent identifiers and incorrect data representation.
-   **Goal:** To create a robust, normalized database structure where every unique POI (defined by its coordinates) has a single, persistent identifier. Map patterns will then simply reference these unique POIs.

---

## The Three Sources of Truth

The entire data linking process relies on three key files:

1.  **`public/assets/maps/poi_coordinates_with_ids.json`**
    -   **Purpose:** The master list of all unique POIs.
    -   **Content:** An array of objects, where each object contains a unique, sequential `id` and the precise `coordinates` for a single POI.
    -   **Generation:** This file was generated by the `scripts/generate_poi_ids.cjs` script, which automatically scanned all map layout JSON files, found every unique coordinate pair, and assigned a persistent ID.
    -   **Role:** This is the canonical source for what constitutes a unique landmark and what its permanent ID is.

2.  **`prisma/poi_name_coordinate_map.js`**
    -   **Purpose:** The human-readable link between a POI's name and its location.
    -   **Content:** A JavaScript object that maps the string name of a POI (as it appears in the CSV) to its corresponding `{ x, y }` coordinates.
    -   **Generation:** This file was pre-populated with a template and is being manually filled out by matching the names from the CSV file to the POIs visible on the map.
    -   **Role:** This file acts as the crucial "Rosetta Stone" that allows the seed script to understand which CSV entry corresponds to which unique coordinate.

3.  **`reference_material/Elden Ring Nightreign map patterns - Patterns.csv`**
    -   **Purpose:** Defines the composition of each of the 320 map patterns.
    -   **Content:** A large spreadsheet where each row represents a unique map pattern. The columns define which POIs (by name) are present in that specific pattern.
    -   **Role:** This file dictates the *relationships* between map patterns and the unique POIs.

---

## The Seeding Script Workflow (`prisma/seed.cjs`)

The final, correct database seeding script will execute the following steps in order:

1.  **Clear the Database:** To ensure a clean slate and prevent data corruption, the script will begin by deleting all existing records from the following tables in this specific order to respect foreign key constraints:
    -   `RouteLandmark`
    -   `MapPatternLandmark`
    -   `Boss`
    -   `Landmark`
    -   `MapPattern`
    -   `Route`

2.  **Seed Unique Landmarks:**
    -   The script will read and parse `public/assets/maps/poi_coordinates_with_ids.json`.
    -   It will then iterate through this master list. For each entry, it will create a **single, unique record** in the `Landmark` table of the database.
    -   Each new landmark record will be saved with its persistent `id`, and its correct `x` and `y` coordinates. The `name` and `type` will be populated from the mapping you are creating.

3.  **Create Lookup Maps:**
    -   The script will load the manually populated `prisma/poi_name_coordinate_map.js`.
    -   It will create two in-memory maps for efficient lookups:
        -   A map from `poiName` -> `coordinates`.
        -   A map from `coordinatesString` -> `landmarkId`.

4.  **Process Patterns and Link Landmarks:**
    -   The script will read and parse the `Patterns.csv` file.
    -   It will iterate through each row of the CSV, treating each row as a unique `MapPattern`.
    -   For each row, it will first create a new record in the `MapPattern` table.
    -   Then, it will iterate through the POI-related cells of that row. For each cell that contains a POI name:
        a. It will get the `poiName` (e.g., "Waypoint Ruins").
        b. It will use the `poiName` -> `coordinates` map to find the corresponding coordinates.
        c. It will use these coordinates to look up the unique, persistent `landmarkId` from the `coordinatesString` -> `landmarkId` map.
        d. Finally, it will create a new record in the `MapPatternLandmark` join table, creating a link between the current `mapPatternId` and the `landmarkId`.

## Final Outcome

After the seed script has run successfully, the database will be in a clean, normalized state:

-   The `Landmark` table will contain exactly 156 unique POIs, each with a permanent ID and correct coordinates.
-   The `MapPattern` table will contain the 320 unique map patterns.
-   The `MapPatternLandmark` table will contain thousands of entries, correctly linking each pattern to its constituent set of unique landmarks.

This will permanently resolve the data integrity issues and provide a solid foundation for the application. 